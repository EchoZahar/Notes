#	REDIS (REmote DIctionary Server)
---

##	Настройка и установка Redis. 
***

### Шаг 1, установка.
---

Установить Redis в Ubuntu 20.04

	sudo apt install redis-server

Откройте файл в текстовом редакторе:

	sudo nano /etc/redis/redis.conf

Внутри файла найдите директиву `supervised`. Эта директива позволяет объявить систему инициализации для управления Redis как службой, предоставляя вам более широкий контроль за ее работой. 
Для директивы `supervised` по умолчанию установлено значение `no`. Поскольку вы запускаете Ubuntu, которая использует систему инициализации `systemd`, измените значение на `systemd`:

`supervised systemd`

Перезапустите службу Redis, чтобы изменения в файле конфигурации вступили в силу:

    sudo systemctl restart redis.service

После этого установка и настройка Redis будет закончена.

### Шаг 2, проверить корректность работы системы.
---

Проверить что служба Redis запущена:

    sudo systemctl status redis


>redis-server.service - Advanced key-value store
>     Loaded: loaded (/lib/systemd/system/redis-server.service; enabled; vendor preset: enabled)
>      Active: active (running) since Sun 2022-01-23 15:22:23 +04; 22s ago
>       Docs: http://redis.io/documentation,
>             man:redis-server(1)
>    Process: 40963 ExecStart=/usr/bin/redis-server /etc/redis/redis.conf (code=exited, status=0/SUCCESS)
>   Main PID: 40964 (redis-server)
>      Tasks: 4 (limit: 8173)
>     Memory: 1.9M
>     CGroup: /system.slice/redis-server.service
>             └─40964 /usr/bin/redis-server 127.0.0.1:6379
>
>янв 23 15:22:23 echo-huawei systemd[1]: Starting Advanced key-value store...
>янв 23 15:22:23 echo-huawei systemd[1]: redis-server.service: Can't open PID file /run/redis/redis-server.pid (yet?) after >start: Operation not permitted
>янв 23 15:22:23 echo-huawei systemd[1]: Started Advanced key-value store.`

Отключение Redis:

    sudo systemctl disable redis

Подключится к серверу можно с помощью клиента командной строки Redi:

    redis-cli

Введите команду:

    ping 

В ответ получите: `PONG`. Данный вывод подтверждает, что подключение сервера активно. <br>
Затем проверьте, что вы можете задать ключи:

    set test "It's working!"

Запросить значение:

    get test

Выйти из Redis консоли:

    quit

![Скриншот](/home/echo/Изображения/test-redis.png)

Последний тест ! Проверка целостности данных после перезапуска.

    sudo systemctl restart redis

Затем снова подключится к клиенту командной строки Redis:

    redis-cli

    get test

Вывод будет: `"It's working!"` <br>
После этого установку Redis можно считать выполненной и готовой к работе.

### Шаг 3, безопасность и привязка к localhost.
---

По умолчанию доступ к Redis осуществляется только из localhost. 
Если вы установили и настроили Redis с помощью другого руководства, вы могли обновить файл конфигурации, 
чтобы разрешить подключение из любого места. 
Подобный подход менее безопасен, чем привязка к localhost. <br>

> Хотя эти шаги не являются обязательными, и Redis будет функционировать, если вы решите не выполнять эти действия, 
> но мы настоятельно рекомендую вам выполнить описанные ниже шаги, чтобы повысить безопасность вашей системы.

Чтобы исправить подключение из любого места, откройте файл конфигурации Redis для редактирования:

    sudo nano /etc/redis/redis.conf

Найдите эту строку и убедитесь, что она незакомментирована (удалите символ #, если он существует): `bind 127.0.0.1 ::1`.


Затем перезапустите службу (если строка: `bind 127.0.0.1 ::1`, была закоментирована), чтобы systemd распознала изменения:

    sudo systemctl restart redis

Чтобы убедиться, что изменение вступило в силу, запустите следующую команду `netstat`:

    sudo netstat -lnp | grep redis

>Команда netstat по умолчанию может отсутствовать в системе. Вы можете установить ее: <br>
> sudo apt install net-tools

Должен быть ответ что то вроде этого:

`tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      40964/redis-server  <br>
tcp6       0      0 ::1:6379                :::*                    LISTEN      40964/redis-server`

Данный вывод указывает, что программа `redis-server` привязана к localhost (127.0.0.1),
если вы увидите другой IP-адрес в этой колонке (например, 0.0.0.0), вам нужно еще раз проверить, 
что вы не закомментировали нужную строку и перезапустить службу Redis. 

Теперь, когда Redis использует только localhost, злоумышленникам будет труднее выполнять запросы или получить доступ к вашему серверу.

### Шаг 4, настройка пароля Redis.
---

> На локальной системе это делать не обязательно !!!

Redis в настоящее время не настроено требование аутентификации пользователей перед внесением изменений в конфигурацию или данные, которые она хранит. 
Чтобы исправить это, Redis позволяет настроить требование аутентификации с помощью пароля перед внесением изменений через клиент Redis `redis-cli`.

Настройка пароля Redis позволяет использовать одну из двух встроенных функций безопасности — команду `auth`, 
которая требует аутентификации клиентов для доступа к базе данных. 
Пароль настраивается непосредственно в файле конфигурации Redis, /etc/redis/redis.conf, 
поэтому вам нужно снова открыть этот файл в предпочитаемом редакторе:

    sudo nano /etc/redis/redis.conf

Прокрутите содержимое файла до раздела `###### SECURITY ######` и найдите следующую закомментированную директиву: <br>

    ...
    # requirepass foobared
    ...

Разкомментируйте ее, удалив символ `#` и измените `foobared` на безопасный пароль. <br>

> Вместо того чтобы придумать пароль самостоятельно, вы можете использовать команду `openssl` для генерации случайного пароля, 
> как в следующем примере. Использовав вывод первой команды во второй команде `openssl`, как показано здесь, 
> вы сможете удалить любые переносы строк, созданные при выполнении первой команды: <br>
>   `openssl rand 60 | openssl base64 -A`
> Вывод будет следующим: <br>
> 3HBX9WE8qBAgaqpwa545xYVgBuS6KSi5EUmXBicBosnU4l9z9pZ4cA094WwnwMOcGRASk2Hu6sXYv2Fm <br>
> Скопируйте и вставьте вывод в /etc/redis/redis.conf <br>
> `requirepass 3HBX9WE8qBAgaqpwa545xYVgBuS6KSi5EUmXBicBosnU4l9z9pZ4cA094WwnwMOcGRASk2Hu6sXYv2Fm`

После установки пароля сохраните и закройте файл, а потом перезапустите Redis.

    sudo systemctl restart redis.service

Чтобы проверить, работает ли пароль, откройте клиент Redis:

    redis-cli

Попробуйте задать ключ: `set key test_value`. <br>
Это не сработает, потому что вы не выполнили аутентификацию, поэтому Redis возвращает ошибку. <br>

`(error) NOAUTH Authentication required.` <br>

Следующая команда выполняет аутентификацию с паролем: `auth you_redis_password`. <br>

Redis принимает пароль: `OK` <br>
После задайте ключ: `set key test_value`, запуск команды будет успешным. Вернет `ok`. <br>
После того как вы убедились что все работает, закройте `redis-cli`, введите `quit`.

### Шаг 5, переименование опасных команд Redis.
---

> На локальной системе это делать не обязательно !!!

Другой элемент безопасности, встроенные в Redis, подразумевает переименование или полное удаление определенных команд, которые считаются опасными.

При использовании неавторизованными пользователями, такие команды могут использоваться для изменения конфигурации, уничтожения или выведения из строя ваших данных. 
Как и в случае пароля для аутентификации, переименование или отключение команд выполняется в том же разделе `### SECURITY ###` в файле `/etc/redis/redis.conf`.

Список команд, которые считаются опасными, включает: `FLUSHDB`, `FLUSHALL`, `KEYS`, `PEXPIRE`, `DEL`, `CONFIG`, `SHUTDOWN`, `BGREWRITEAOF`, `BGSAVE`, `SAVE`, `SPOP`, `SREM`, `RENAME` и `DEBUG`.
Данный список не является всеобъемлющим, но переименование или удаление всех команд в этом списке служит хорошим отправным пунктом для повышения безопасности вашего сервера Redis.

> [Список команд Redis](https://redis.io/commands "Оф. сайт Redis")

Чтобы отключить команду, укажите пустую строчку в кавычках `""` файле `/etc/redis/redis.conf`: <br>
`rename-command FLUSHDB ""` <br>
`rename-command DEBUG ""` 

Чтобы переименовать команду, сначала введите наименование команды, а затем наименование новой команды.

Пример:

`rename-command SHUTDOWN SHUTDOWN_RENAME` <br>
`rename-command CONFIG ASC12_CONFIG`

После всех изменений, перезапустите Redis:

    sudo systemctl restart redis.service

Протестируйте ввести старую команду (`redis-cli`, аутентификация: `auth your_redis_password`):

Пример: 

    config get requirepass

Вы получите ошибку: `(error) ERR unknown command `config`, with args beginning with:`. 

Теперь переименованную команду:

    asc12_config get requirepass

Результат выполнения будет: <br>
`1) "requirepass"` <br>
`2) "your_redis_password"`

### В заключении.
---

После входа на ваш сервер очень легко будет обойти защитные функции Redis, которые мы настроили. 
Поэтому наиболее важным элементом безопасности на вашем сервере Redis является ваш брандмауэр (который вы должны были настроить на этапе первоначальной настройки сервера), 
поскольку злоумышленникам очень трудно преодолеть эту преграду.

Для вывода помощи по списку команд в консоли можно использовать команду:

    HELP @string

Для вывода помощи по конкретной команде:

    HELP APPEND

